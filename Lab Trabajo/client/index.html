<!DOCTYPE html>
<html>

<head>
    
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <style>
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            /* Safari */
            animation: spin 2s linear infinite;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <table style="border: hidden" width="1300" cellspacing="1" cellpadding="3">
        <tbody style="border: hidden">
            <tr style="border: hidden">
                <table width="1300" cellspacing="1" cellpadding="3" border="10" bgcolor="#1E679A"
                    style="border: hidden;">
                    <tr>
                        <td>
                            <font color="#FFFFFF" face="arial, verdana, helvetica">
                                <b>
                                    <center>Seleccionar la imagen
                                </b>
                            </font>
                        </td>
                    </tr>
                    <tr style="border: hidden">
                        <td bgcolor="#ffffcc">
                            <font face="arial, verdana, helvetica">
                                <b>Ingresa el archivo:</b>
                                <center>
                                    <form id='sendForm' method="POST" action="/loadImg" enctype="multipart/form-data">
                                        <br>

                                        <input id='fileCh' name='files' type='file' />
                                        <button id='cargarArchivo' disabled="disabled" type="submit"
                                        value="Cargar Archivo" >Cargar archivo</button> 

                                    </form>
                            </font>
                        </td>
                    </tr>
                </table>
            </tr>
            <br><br><br><br><br><br><br><br><br><br>
            <div id="imgRes">
            </div>
            <tr style="border: hidden">
                <table width="1300" cellspacing="1" cellpadding="3" border="10" bgcolor="#1E679A"
                    style="border: hidden;">
                    <tr>
                        <td>
                            <font color="#FFFFFF" face="arial, verdana, helvetica">
                                <form id='sendForm' method="POST" action="/loadImg" enctype="multipart/form-data">
                                    <b>
                                        <center>Seleccionar servidor
                                    </b>
                            </font>
                        </td>
                    </tr>
                    <tr style="border: hidden">
                        <td bgcolor="#ffffcc">
                            <div id="server">
                                <font face="arial, verdana, helvetica">
                                    <center>
                                        <label>Ip Servidor: <input type="text" id="ip" /></label>
                                        <label>Puerto: <input type="text" id="port" /></label>
                                        <br><br>
                                        <button onclick="addServer()">Agregar Nuevo Servidor</button>
                            </div>
                        </td>
                    </tr>
                </table>
            </tr>
        </tbody>
    </table>


    <br />
</body>

<script>
    

    var middleware = "http://localhost:3005/"
    var ipServer = "";
    var result = null;
    var data = null;
    $("#fileCh").change(function(){
    $("button").prop("disabled", this.files.length == 0);
});
    document.getElementById('sendForm').onsubmit = async (e) => {
        e.preventDefault();
        var responseA = await fetch(middleware, {
            method: 'GET'
        })
        resultA = await responseA.text();
        console.log(resultA);
        ipServer = resultA;
        if (ipServer != 'Error') {
            var response = await fetch(ipServer + 'loadImg', {
                method: 'POST',
                body: new FormData(document.getElementById('sendForm'))
            })
            result = await response.text();
            console.log(result);
            if (result != null) {
                data = {
                    fileName: result
                }
                document.getElementById("imgRes").innerHTML = "<div class='loader'/>";
                loadedElement();
            };
        } else {
            alert("No hay servidores disponibles")
        }
    }

  
    function loadedElement() {
        setTimeout(function () { document.getElementById("imgRes").innerHTML = '<button onclick="loadImage()">Mostrar</>'; }, 5000)
    }
   
    function loadImage() {
    
        $.post(ipServer + 'getImage', data)
            .done(function (res) {
                $('#imgRes').html(res);
            })
          
        document.getElementById('fileCh').value = null;
    }



    function addServer() {
        var serverInfo = {
            ipServer: document.getElementById("ip").value,
            portServer: document.getElementById("port").value
        }
        console.log("Solicitud con: " + serverInfo.ipServer + serverInfo.portServer)
        $.post(middleware + 'addServer', serverInfo)
            .done(function (res) {
                alert(res)
            })
        document.getElementById("ip").value = null;
        document.getElementById("port").value = null;
    }


</script>

</html>